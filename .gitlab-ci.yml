stages:
  - build

variables:
  PYTEST_NUMBER_OF_PROCESSES: 8
  CTEST_NUMBER_OF_JOBS: 4
  GIT_DEPTH: 20
  GIT_SUBMODULE_STRATEGY: recursive
  FF_ENABLE_JOB_CLEANUP: 1
  GIT_STRATEGY: clone
  # uses registry.gitlab.syncad.com/hive/haf/ci-base-image:ubuntu22.04-12
  BUILDER_IMAGE_TAG: "@sha256:50d08c0e525c6252c772a4443e0b6d445008ac6a6479e8e7028adace99d42509"
  CI_DEBUG_SERVICES: "true"
  SETUP_SCRIPTS_PATH: "$CI_PROJECT_DIR/scripts"
  TEST_TOOLS_NODE_DEFAULT_WAIT_FOR_LIVE_TIMEOUT: 60
  DATA_CACHE_HAF_PREFIX: "/cache/replay_data_haf"
  BLOCK_LOG_SOURCE_DIR_5M: /blockchain/block_log_5m
  SNAPSHOTS_PATH: /cache/snapshots_pipeline_${CI_PIPELINE_ID}
  BLOCK_LOG_SOURCE_DIR_MIRRORNET_5M: /cache/block_log_5m_mirrornet

include:
  - template: Workflows/Branch-Pipelines.gitlab-ci.yml
  - local: '/scripts/ci-helpers/prepare_data_image_job.yml'

mirrornet_node_build:
  stage: build
  extends: .prepare_hived_image
  variables:
    SUBMODULE_DIR: "${CI_PROJECT_DIR}/hive"
    REGISTRY_USER: "${HIVED_CI_IMGBUILDER_USER}"
    REGISTRY_PASS: "${HIVED_CI_IMGBUILDER_PASSWORD}"
    BINARY_CACHE_PATH: "${CI_PROJECT_DIR}/hived-mirrornet-binaries"
    HIVE_NETWORK_TYPE: mirrornet
  tags:
    - public-runner-docker
    - hived-for-tests

extended_block_log_creation:
  extends: .extended_block_log_creation
  stage: build
  needs:
    - job: "mirrornet_node_build"
      artifacts: true
  variables:
    REGISTRY: "registry.gitlab.syncad.com/hive/hive"
    REGISTRY_USER: "${HIVED_CI_IMGBUILDER_USER}"
    REGISTRY_PASS: "${HIVED_CI_IMGBUILDER_PASSWORD}"
    IMAGE_TAG: "312f1d0a"
    HIVE_SRC: "${CI_PROJECT_DIR}/hive"
    BLOCK_LOG_SOURCE_DIR: "/blockchain/block_log_5m"
    BINARY_PATH: "${CI_PROJECT_DIR}/hived-mirrornet-binaries"
  tags:
    - public-runner-docker
    - hived-for-tests